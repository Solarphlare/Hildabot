name: Build and Deploy

on:
    push:
        paths:
            - '**.cc'
            - '**.h'
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install Library Dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y libopus-dev
            - name: Install DPP
              run: |
                git clone https://github.com/brainboxdotcc/DPP
                cd DPP
                git switch --detach v10.1.3
                cmake -B ./build
                cmake --build ./build -j $(nproc)
                cd build
                sudo make install
            - name: Install mongocxx
              run: |
                curl -sOLf https://github.com/mongodb/mongo-cxx-driver/releases/download/r4.1.2/mongo-cxx-driver-r4.1.2.tar.gz
                tar -xzf mongo-cxx-driver-r4.1.2.tar.gz
                cd mongo-cxx-driver-r4.1.2/build
                cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=20
                cmake --build .
                sudo cmake --build . --target install
            - name: Prepare Files
              env:
                CONFIG_DATA: ${{ secrets.CONFIG_DATA }}
              run: echo $CONFIG_DATA | base64 -d > $GITHUB_WORKSPACE/src/include/config.h
            - name: Build Project
              run: make
            - name: Sign Binary
              env:
                SIGNATURE_KEY: ${{ secrets.SIGNATURE_KEY }}
              run: echo $SIGNATURE_KEY | base64 -d > $GITHUB_WORKSPACE/signature.pem && openssl dgst -sha256 -sign $GITHUB_WORKSPACE/signature.pem -out $GITHUB_WORKSPACE/hildabot.signature $GITHUB_WORKSPACE/hildabot
            - name: Deploy Project
              env:
                DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
                DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
              run: "curl -sf -X POST -F payload=@$GITHUB_WORKSPACE/hildabot -F signaturefile=@$GITHUB_WORKSPACE/hildabot.signature -H \"Authorization: $DEPLOY_KEY\" -m 30 $DEPLOY_URL"

